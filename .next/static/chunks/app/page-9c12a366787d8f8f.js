(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{67:function(){},2061:function(){},2115:function(e,t,a){Promise.resolve().then(a.bind(a,3289))},3289:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return U}});var s=a(7437),n=a(2265);let l={contractedPowerKw:500,method:"MAX_PEAK",compliance:.95,safetyFactor:1.2,efficiency:.9,interpretationMode:"AUTO",includeHistogram:!0,includePeakEventsTable:!0,includeScenarioSection:!0};var i=a(7625),r=a(6293),o=a(6940),c=a(7059),d=a(2994),m=a(8147),h=a(1699),u=a(4061),p=a(8556),x=a(407);let v=Date.UTC(1899,11,30);function w(e){if(e instanceof Date)return e;if("number"==typeof e&&Number.isFinite(e))return new Date(v+864e5*e);let t=String(null!=e?e:"").trim();if(!t)return new Date(Number.NaN);let a=Number(t);return new Date(Number.isFinite(a)&&/^\d+(\.\d+)?$/.test(t)?v+864e5*a:t)}function g(e){let t="string"==typeof e?w(e):e;if(Number.isNaN(t.getTime()))return"-";let a=Object.fromEntries(new Intl.DateTimeFormat("nl-NL",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1,timeZone:"Europe/Amsterdam"}).formatToParts(t).map(e=>[e.type,e.value]));return"".concat(a.day,"-").concat(a.month,"-").concat(a.year," ").concat(a.hour,":").concat(a.minute)}function f(e){var t;let{intervals:a,contractKw:n,topEvents:l,highestPeakDay:v,topExceededIntervals:w}=e,f=null!=v?v:null===(t=a[0])||void 0===t?void 0:t.timestamp.slice(0,10),b=new Set(w.map(e=>e.timestamp)),j=a.filter(e=>e.timestamp.slice(0,10)===f).map(e=>({...e,contractKw:n,isTopExceeded:b.has(e.timestamp)})),N=Math.max(1,...a.map(e=>e.consumptionKw))/20,K=Array.from({length:20},(e,t)=>{let s=t*N,l=s+N,i=a.filter(e=>e.consumptionKw>=s&&(19===t?e.consumptionKw<=l:e.consumptionKw<l)).length,r="".concat(s.toFixed(0),"-").concat(l.toFixed(0)),o=l/n;return{label:r,count:i,bucketType:o>1?"over100":o>.9?"over90":"normal"}});return(0,s.jsxs)("div",{className:"grid gap-4 lg:grid-cols-2",children:[(0,s.jsxs)("div",{className:"rounded-lg border bg-white p-4",children:[(0,s.jsx)("h3",{className:"mb-2 font-semibold",children:"Highest Peak Day Profile"}),(0,s.jsx)("div",{className:"h-64",children:(0,s.jsx)(i.h,{children:(0,s.jsxs)(r.c,{data:j,children:[(0,s.jsx)(o.q,{strokeDasharray:"3 3"}),(0,s.jsx)(c.K,{dataKey:"timestamp",hide:!0}),(0,s.jsx)(d.B,{}),(0,s.jsx)(m.u,{}),(0,s.jsx)(h.$,{dataKey:"consumptionKw",fill:"#3b82f6"}),(0,s.jsx)(u.x,{type:"monotone",dataKey:"contractKw",stroke:"#ef4444",dot:!1}),j.filter(e=>e.isTopExceeded).map(e=>(0,s.jsx)(p.q,{x:e.timestamp,y:e.consumptionKw,r:4,fill:"#ef4444",stroke:"#7f1d1d"},e.timestamp))]})})}),(0,s.jsx)("div",{className:"mt-3 max-h-40 overflow-y-auto rounded border",children:(0,s.jsxs)("table",{className:"min-w-full text-xs",children:[(0,s.jsx)("thead",{className:"sticky top-0 bg-slate-50",children:(0,s.jsxs)("tr",{className:"border-b text-left",children:[(0,s.jsx)("th",{className:"p-2",children:"Timestamp"}),(0,s.jsx)("th",{className:"p-2",children:"Consumption kW"}),(0,s.jsx)("th",{className:"p-2",children:"Excess kW"})]})}),(0,s.jsx)("tbody",{children:w.map(e=>(0,s.jsxs)("tr",{className:"border-b",children:[(0,s.jsx)("td",{className:"p-2",children:g(e.timestamp)}),(0,s.jsx)("td",{className:"p-2",children:e.consumption_kW.toFixed(2)}),(0,s.jsx)("td",{className:"p-2",children:e.excess_kW.toFixed(2)})]},e.timestamp))})]})})]}),(0,s.jsxs)("div",{className:"rounded-lg border bg-white p-4",children:[(0,s.jsx)("h3",{className:"mb-2 font-semibold",children:"Consumption Histogram"}),(0,s.jsx)("div",{className:"h-64",children:(0,s.jsx)(i.h,{children:(0,s.jsxs)(r.c,{data:K,children:[(0,s.jsx)(o.q,{strokeDasharray:"3 3"}),(0,s.jsx)(c.K,{dataKey:"label",hide:!0}),(0,s.jsx)(d.B,{}),(0,s.jsx)(m.u,{}),(0,s.jsx)(h.$,{dataKey:"count",children:K.map((e,t)=>(0,s.jsx)(x.b,{fill:"over100"===e.bucketType?"#dc2626":"over90"===e.bucketType?"#f59e0b":"#10b981"},"cell-".concat(t)))})]})})})]}),(0,s.jsxs)("div",{className:"rounded-lg border bg-white p-4 lg:col-span-2",children:[(0,s.jsx)("h3",{className:"mb-2 font-semibold",children:"Top 10 Peak Events"}),(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsxs)("table",{className:"min-w-full text-sm",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{className:"border-b text-left",children:[(0,s.jsx)("th",{className:"p-2",children:"Peak timestamp"}),(0,s.jsx)("th",{className:"p-2",children:"Duration"}),(0,s.jsx)("th",{className:"p-2",children:"Max excess kW"}),(0,s.jsx)("th",{className:"p-2",children:"Total excess kWh"})]})}),(0,s.jsx)("tbody",{children:l.slice(0,10).map(e=>(0,s.jsxs)("tr",{className:"border-b",children:[(0,s.jsx)("td",{className:"p-2",children:g(e.peakTimestamp)}),(0,s.jsx)("td",{className:"p-2",children:e.durationIntervals}),(0,s.jsx)("td",{className:"p-2",children:e.maxExcessKw.toFixed(2)}),(0,s.jsx)("td",{className:"p-2",children:e.totalExcessKwh.toFixed(2)})]},"".concat(e.peakTimestamp,"-").concat(e.durationIntervals)))})]})})]})]})}function b(e){let{headers:t,mapping:a,onChange:n}=e,l=(e,t)=>{n({...a,[e]:t})};return(0,s.jsxs)("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[(0,s.jsx)("h2",{className:"mb-2 font-semibold",children:"Column Mapping"}),(0,s.jsx)("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[["timestamp","timestamp"],["consumptionKwh","consumption_kwh"],["exportKwh","export_kwh (optional)"],["pvKwh","pv_kwh (optional)"]].map(e=>{var n;let[i,r]=e;return(0,s.jsxs)("label",{className:"text-sm",children:[r,(0,s.jsxs)("select",{className:"mt-1 w-full rounded border p-2",value:null!==(n=a[i])&&void 0!==n?n:"",onChange:e=>l(i,e.target.value),children:[(0,s.jsx)("option",{value:"",children:"Select column"}),t.map(e=>(0,s.jsx)("option",{value:e,children:e},e))]})]},i)})})]})}function j(e){let{compliance:t,onChange:a}=e;return(0,s.jsxs)("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("label",{className:"font-semibold",children:"Compliance target"}),(0,s.jsxs)("span",{className:"text-sm",children:[Math.round(100*t),"%"]})]}),(0,s.jsx)("input",{className:"mt-3 w-full",type:"range",min:70,max:100,step:1,value:Math.round(100*t),onChange:e=>a(Number(e.target.value)/100)}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-600",children:"Compliance = target percentage of peak exceedance to shave."})]})}function N(e){let{diagnostics:t,quality:a}=e,n="AUTO"===t.interpretationRequested?"AUTO -> ".concat(t.interpretationUsed):t.interpretationUsed;return(0,s.jsxs)("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[(0,s.jsx)("h3",{className:"font-semibold",children:"Data quality"}),(0,s.jsxs)("div",{className:"mt-2 grid gap-2 text-sm md:grid-cols-2",children:[(0,s.jsxs)("p",{children:["Interpretatie: ",n]}),(0,s.jsxs)("p",{children:["Rijen totaal/gebruikt: ",t.rowsTotal," / ",t.rowsUsed]}),(0,s.jsxs)("p",{children:["Missing intervals: ",a.missingIntervalsCount]}),(0,s.jsxs)("p",{children:["Outliers uitgesloten: ",t.countOutliers,t.firstOutlierTimestamp?" (eerste: ".concat(g(t.firstOutlierTimestamp),")"):""]}),(0,s.jsxs)("p",{children:["Negatieve deltas: ",t.negativeDeltaCount]})]})]})}function K(e){let{maxObservedKw:t,maxObservedTimestamp:a,exceedanceIntervals:n,sizing:l}=e,i=[{label:"Max observed kW",value:t.toFixed(2),subtext:a?g(a):"-"},{label:"Exceedance intervals",value:String(n)},{label:"kWh needed",value:l.kWhNeeded.toFixed(2)},{label:"kW needed",value:l.kWNeeded.toFixed(2)},{label:"Recommended",value:l.recommendedProduct.capacityKwh+" kWh"}];return(0,s.jsx)("div",{className:"grid grid-cols-2 gap-3 lg:grid-cols-5",children:i.map(e=>(0,s.jsxs)("div",{className:"rounded-lg border bg-white p-3 shadow-sm",children:[(0,s.jsx)("div",{className:"text-xs text-slate-500",children:e.label}),(0,s.jsx)("div",{className:"text-lg font-semibold",children:e.value}),"subtext"in e&&e.subtext?(0,s.jsx)("div",{className:"text-xs text-slate-500",children:e.subtext}):null]},e.label))})}function y(e){var t,a,n;let{scenarios:l,selectedScenarioCapacity:p,onSelectScenario:x}=e,v=null!==(a=l.find(e=>e.capacityKwh===p))&&void 0!==a?a:l[0],w=null==v?void 0:null===(t=v.shavedSeries[0])||void 0===t?void 0:t.timestamp.slice(0,10),g=null!==(n=null==v?void 0:v.shavedSeries.filter(e=>e.timestamp.slice(0,10)===w))&&void 0!==n?n:[];return(0,s.jsxs)("div",{className:"grid gap-4 lg:grid-cols-2",children:[(0,s.jsxs)("div",{className:"rounded-lg border bg-white p-4",children:[(0,s.jsx)("h3",{className:"mb-2 font-semibold",children:"Exceedance energy before/after"}),(0,s.jsx)("div",{className:"h-64",children:(0,s.jsx)(i.h,{children:(0,s.jsxs)(r.c,{data:l,children:[(0,s.jsx)(o.q,{strokeDasharray:"3 3"}),(0,s.jsx)(c.K,{dataKey:"capacityKwh"}),(0,s.jsx)(d.B,{}),(0,s.jsx)(m.u,{}),(0,s.jsx)(h.$,{dataKey:"exceedanceEnergyKwhBefore",fill:"#f97316",name:"Before"}),(0,s.jsx)(h.$,{dataKey:"exceedanceEnergyKwhAfter",fill:"#3b82f6",name:"After"})]})})})]}),(0,s.jsxs)("div",{className:"rounded-lg border bg-white p-4",children:[(0,s.jsxs)("div",{className:"mb-2 flex items-center justify-between",children:[(0,s.jsx)("h3",{className:"font-semibold",children:"Highest peak day overlay"}),(0,s.jsx)("select",{value:p,onChange:e=>x(Number(e.target.value)),className:"rounded border p-1 text-sm",children:l.map(e=>(0,s.jsxs)("option",{value:e.capacityKwh,children:[e.capacityKwh," kWh"]},e.capacityKwh))})]}),(0,s.jsx)("div",{className:"h-64",children:(0,s.jsx)(i.h,{children:(0,s.jsxs)(r.c,{data:g,children:[(0,s.jsx)(o.q,{strokeDasharray:"3 3"}),(0,s.jsx)(c.K,{dataKey:"timestamp",hide:!0}),(0,s.jsx)(d.B,{}),(0,s.jsx)(m.u,{}),(0,s.jsx)(u.x,{dataKey:"originalKw",stroke:"#ef4444",dot:!1,name:"Original"}),(0,s.jsx)(u.x,{dataKey:"shavedKw",stroke:"#10b981",dot:!1,name:"Shaved"})]})})})]})]})}function E(e){let{scenarios:t,recommendedCapacityKwh:a}=e;return(0,s.jsxs)("div",{className:"rounded-lg border bg-white p-4",children:[(0,s.jsx)("h3",{className:"mb-2 font-semibold",children:"Multi-battery scenario comparison"}),(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsxs)("table",{className:"min-w-full text-sm",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{className:"border-b text-left",children:[(0,s.jsx)("th",{className:"p-2",children:"Option"}),(0,s.jsx)("th",{className:"p-2",children:"Before kWh"}),(0,s.jsx)("th",{className:"p-2",children:"After kWh"}),(0,s.jsx)("th",{className:"p-2",children:"Dataset compliance"}),(0,s.jsx)("th",{className:"p-2",children:"Daily avg compliance"}),(0,s.jsx)("th",{className:"p-2",children:"Remaining max kW"})]})}),(0,s.jsx)("tbody",{children:t.map(e=>(0,s.jsxs)("tr",{className:"border-b ".concat(e.capacityKwh===a?"bg-emerald-50":""),children:[(0,s.jsx)("td",{className:"p-2",children:e.optionLabel}),(0,s.jsx)("td",{className:"p-2",children:e.exceedanceEnergyKwhBefore.toFixed(2)}),(0,s.jsx)("td",{className:"p-2",children:e.exceedanceEnergyKwhAfter.toFixed(2)}),(0,s.jsxs)("td",{className:"p-2",children:[(100*e.achievedComplianceDataset).toFixed(1),"%"]}),(0,s.jsxs)("td",{className:"p-2",children:[(100*e.achievedComplianceDailyAverage).toFixed(1),"%"]}),(0,s.jsx)("td",{className:"p-2",children:e.maxRemainingExcessKw.toFixed(2)})]},e.capacityKwh))})]})})]})}function k(e){let{onFile:t}=e;return(0,s.jsxs)("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[(0,s.jsx)("label",{className:"mb-2 block text-sm font-medium",children:"Upload CSV or XLSX"}),(0,s.jsx)("input",{type:"file",accept:".csv,.xlsx",onChange:e=>{var a;let s=null===(a=e.target.files)||void 0===a?void 0:a[0];s&&t(s)}})]})}let T=[{label:"WattsNext ESS Cabinet 64 kWh",capacityKwh:64},{label:"WattsNext ESS Cabinet 96 kWh",capacityKwh:96},{label:"ESS All-in-one Cabinet 261 kWh",capacityKwh:261},{label:"WattsNext All-in-one Container 2.09 MWh",capacityKwh:2090},{label:"WattsNext All in-one Container 5.01 MWh",capacityKwh:5010}];function C(e,t){if(0===e.length)return 0;let a=[...e].sort((e,t)=>e-t),s=Math.ceil(t/100*a.length)-1;return a[Math.max(0,Math.min(s,a.length-1))]}var S=a(5452),M=a.n(S),A=a(2093);function D(e){var t,a,s,n;let l=new Map(e.map(e=>[e.trim().toLowerCase(),e])),i=null!==(a=null!==(t=l.get("timestamp"))&&void 0!==t?t:l.get("date"))&&void 0!==a?a:l.get("datetime"),r=null!==(n=null!==(s=l.get("consumption_kwh"))&&void 0!==s?s:l.get("consumption"))&&void 0!==n?n:l.get("load_kwh");return i&&r?{timestamp:i,consumptionKwh:r,exportKwh:l.get("export_kwh"),pvKwh:l.get("pv_kwh")}:null}function O(e,t){let a=[];return e.forEach(e=>{let s=e[t.timestamp],n=e[t.consumptionKwh],l=t.exportKwh?e[t.exportKwh]:void 0,i=t.pvKwh?e[t.pvKwh]:void 0,r=w(s),o=Number(n);Number.isNaN(r.getTime())||Number.isNaN(o)||a.push({timestamp:r.toISOString(),consumptionKwh:o,exportKwh:null==l?void 0:Number(l),pvKwh:null==i?void 0:Number(i)})}),a.sort((e,t)=>e.timestamp.localeCompare(t.timestamp))}function U(){var e,t,a,i,r,o,c,d,m,h,u;let[p,x]=(0,n.useState)([]),[v,g]=(0,n.useState)([]),[S,U]=(0,n.useState)({timestamp:"",consumptionKwh:""}),[P,L]=(0,n.useState)(null),[I,_]=(0,n.useState)(l),[F,W]=(0,n.useState)(null),[R,z]=(0,n.useState)(null),[V,q]=(0,n.useState)(null),[B,H]=(0,n.useState)(64),[X,$]=(0,n.useState)(null),G=(0,n.useMemo)(()=>S.timestamp&&S.consumptionKwh?O(p,S):[],[S,p]).length>0&&I.contractedPowerKw>0&&I.efficiency>0&&I.compliance>=.7&&I.compliance<=1,J=!!F&&(I.contractedPowerKw!==F.contractedPowerKw||I.method!==F.method||I.compliance!==F.compliance||I.safetyFactor!==F.safetyFactor||I.efficiency!==F.efficiency||I.interpretationMode!==F.interpretationMode||(null===(t=I.includeHistogram)||void 0===t||t)!==(null===(a=F.includeHistogram)||void 0===a||a)||(null===(i=I.includePeakEventsTable)||void 0===i||i)!==(null===(r=F.includePeakEventsTable)||void 0===r||r)||(null===(o=I.includeScenarioSection)||void 0===o||o)!==(null===(c=F.includeScenarioSection)||void 0===c||c)||!P||P.timestamp!==S.timestamp||P.consumptionKwh!==S.consumptionKwh||(null!==(d=P.exportKwh)&&void 0!==d?d:"")!==(null!==(m=S.exportKwh)&&void 0!==m?m:"")||(null!==(h=P.pvKwh)&&void 0!==h?h:"")!==(null!==(u=S.pvKwh)&&void 0!==u?u:"")),Z=async e=>{$(null);try{let t=null;if(e.name.toLowerCase().endsWith(".csv")){let a=await e.text(),s=function(e){var t;let a=M().parse(e,{header:!0,skipEmptyLines:!0});if(a.errors.length>0)throw Error("CSV parsing failed: ".concat(a.errors[0].message));let s=null!==(t=a.meta.fields)&&void 0!==t?t:[];return{rows:a.data,headers:s}}(a);x(s.rows),g(s.headers),t=D(s.headers)}else{let a=await e.arrayBuffer(),s=function(e){let t=A.ij(e,{type:"array"}),a=t.Sheets[t.SheetNames[0]],s=A.P6.sheet_to_json(a,{defval:null}),n=s.length>0?Object.keys(s[0]):[];return{rows:s,headers:n}}(a);x(s.rows),g(s.headers),t=D(s.headers)}t&&U(t),W(null),L(null),z(null),q(null)}catch(e){$(e instanceof Error?e.message:"Could not parse file")}},Q=async()=>{if(!R||!F)return;let e=await fetch("/api/report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contractedPowerKw:F.contractedPowerKw,maxObservedKw:R.maxObservedKw,maxObservedTimestamp:R.maxObservedTimestamp,exceedanceCount:R.events.length,compliance:F.compliance,method:F.method,efficiency:F.efficiency,safetyFactor:F.safetyFactor,sizing:R.sizing,quality:R.quality,topEvents:R.events,scenarios:R.scenarios})}),t=await e.blob(),a=URL.createObjectURL(t),s=document.createElement("a");s.href=a,s.download="peak-shaving-report.pdf",s.click(),URL.revokeObjectURL(a)};return(0,s.jsxs)("main",{className:"mx-auto max-w-7xl space-y-4 p-4",children:[(0,s.jsx)("h1",{className:"text-2xl font-bold",children:"Peak Shaving Advisor (MVP)"}),(0,s.jsx)("p",{className:"text-sm text-slate-600",children:"Upload 15-minute interval data and generate a battery advice report."}),(0,s.jsx)(k,{onFile:Z}),X&&(0,s.jsx)("p",{className:"rounded border border-red-200 bg-red-50 p-3 text-red-700",children:X}),v.length>0&&(0,s.jsx)(b,{headers:v,mapping:S,onChange:U}),(0,s.jsxs)("div",{className:"grid gap-4 rounded-lg border bg-white p-4 shadow-sm lg:grid-cols-3",children:[(0,s.jsxs)("label",{className:"text-sm",children:["Contracted power (kW)",(0,s.jsx)("input",{className:"mt-1 w-full rounded border p-2",type:"number",value:I.contractedPowerKw,onChange:e=>_(t=>({...t,contractedPowerKw:Number(e.target.value)}))})]}),(0,s.jsxs)("label",{className:"text-sm",children:["Method",(0,s.jsxs)("select",{className:"mt-1 w-full rounded border p-2",value:I.method,onChange:e=>_(t=>({...t,method:e.target.value})),children:[(0,s.jsx)("option",{value:"MAX_PEAK",children:"MAX_PEAK"}),(0,s.jsx)("option",{value:"P95",children:"P95"}),(0,s.jsx)("option",{value:"FULL_COVERAGE",children:"FULL_COVERAGE"})]})]}),(0,s.jsxs)("label",{className:"text-sm",children:["Interpretation",(0,s.jsxs)("select",{className:"mt-1 w-full rounded border p-2",value:I.interpretationMode,onChange:e=>_(t=>({...t,interpretationMode:e.target.value})),children:[(0,s.jsx)("option",{value:"AUTO",children:"Auto"}),(0,s.jsx)("option",{value:"INTERVAL",children:"Interval values"}),(0,s.jsx)("option",{value:"CUMULATIVE_DELTA",children:"Cumulative meter readings (delta)"})]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,s.jsxs)("label",{className:"text-sm",children:["Safety factor",(0,s.jsx)("input",{className:"mt-1 w-full rounded border p-2",type:"number",step:"0.01",value:I.safetyFactor,onChange:e=>_(t=>({...t,safetyFactor:Number(e.target.value)}))})]}),(0,s.jsxs)("label",{className:"text-sm",children:["Efficiency",(0,s.jsx)("input",{className:"mt-1 w-full rounded border p-2",type:"number",step:"0.01",value:I.efficiency,onChange:e=>_(t=>({...t,efficiency:Number(e.target.value)}))})]})]}),(0,s.jsx)("div",{className:"lg:col-span-3",children:(0,s.jsx)(j,{compliance:I.compliance,onChange:e=>_(t=>({...t,compliance:e}))})}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("button",{className:"rounded bg-blue-600 px-4 py-2 font-semibold text-white hover:bg-blue-700 disabled:opacity-60",onClick:()=>{if($(null),!S.timestamp||!S.consumptionKwh){$("Selecteer eerst timestamp- en consumption-kolommen.");return}if(!G){$("Controleer instellingen en data voordat je analyseert.");return}let e=function(e,t,a){var s,n;let l=O(e,t);if(0===l.length)return null;let i=function(e){var t,a,s,n,l;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=(null!==(t=i.intervalMinutes)&&void 0!==t?t:15)/60,o=null!==(a=i.interpretationMode)&&void 0!==a?a:"AUTO",c=null!==(s=i.outlierKwThreshold)&&void 0!==s?s:5e3,d=null!==(n=i.allowNegativeDeltas)&&void 0!==n&&n,m=null!==(l=i.hugeKwhThreshold)&&void 0!==l?l:1e3,h=[],u=[];e.forEach(e=>{let t=w(e.timestamp),a=Number(e.consumptionKwh);Number.isNaN(t.getTime())||Number.isNaN(a)||u.push({timestamp:t.toISOString(),consumptionKwh:a,exportKwh:e.exportKwh,pvKwh:e.pvKwh})}),u.sort((e,t)=>e.timestamp.localeCompare(t.timestamp));let p=function(e,t,a){if(e.length<2)return{interpretationUsed:"CUMULATIVE_DELTA"===t?"CUMULATIVE_DELTA":"INTERVAL",fractionNonDecreasing:0,medianDelta:0,fractionHugeValues:1===e.length&&e[0]>a?1:0};let s=0,n=[],l=0;for(let t=0;t<e.length;t+=1)if(e[t]>a&&(l+=1),t>0){let a=e[t]-e[t-1];n.push(a),e[t]>=e[t-1]&&(s+=1)}let i=s/(e.length-1),r=function(e){if(0===e.length)return 0;let t=[...e].sort((e,t)=>e-t),a=Math.floor(t.length/2);return t.length%2==0?(t[a-1]+t[a])/2:t[a]}(n),o=l/e.length;return"INTERVAL"===t?{interpretationUsed:"INTERVAL",fractionNonDecreasing:i,medianDelta:r,fractionHugeValues:o}:"CUMULATIVE_DELTA"===t?{interpretationUsed:"CUMULATIVE_DELTA",fractionNonDecreasing:i,medianDelta:r,fractionHugeValues:o}:{interpretationUsed:i>.98&&r>=0||o>.001?"CUMULATIVE_DELTA":"INTERVAL",fractionNonDecreasing:i,medianDelta:r,fractionHugeValues:o}}(u.map(e=>e.consumptionKwh),o,m),x=0,v=0,g=null,f=null,b=[];for(let e=0;e<u.length;e+=1){let t=u[e],a=t.consumptionKwh;if("CUMULATIVE_DELTA"===p.interpretationUsed){if(0===e)a=0;else{let s=t.consumptionKwh-u[e-1].consumptionKwh;s<0&&!d?(x+=1,a=0):a=s}}if(a<0)continue;let s=a/r;if(s>c){v+=1,g=null==g?s:Math.max(g,s),f=null!=f?f:t.timestamp;continue}b.push({...t,consumptionKwh:a})}return x>0&&h.push("".concat(x," negatieve delta(s) zijn op 0 gezet.")),v>0&&h.push("".concat(v," outlier(s) boven ").concat(c," kW uitgesloten.")),{normalizedRows:b,diagnostics:{interpretationRequested:o,interpretationUsed:p.interpretationUsed,rowsTotal:e.length,rowsUsed:b.length,invalidRows:e.length-u.length,countOutliers:v,maxOutlierKw:g,firstOutlierTimestamp:f,negativeDeltaCount:x,fractionNonDecreasing:p.fractionNonDecreasing,medianDelta:p.medianDelta,fractionHugeValues:p.fractionHugeValues,warnings:h}}}(l,{intervalMinutes:15,interpretationMode:a.interpretationMode,outlierKwThreshold:5e3,allowNegativeDeltas:!1});if(0===i.normalizedRows.length)return null;let r=(s=i.normalizedRows,n=a.contractedPowerKw,s.map(e=>{let t=w(e.timestamp),a=Number.isNaN(t.getTime())?e.timestamp:t.toISOString(),s=e.consumptionKwh/.25,l=Math.max(0,s-n);return{...e,timestamp:a,consumptionKw:s,excessKw:l,excessKwh:.25*l}})),o=function(e){let t=[],a=null;return e.forEach((e,s)=>{e.excessKw>0?(a||(a={peakTimestamp:e.timestamp,durationIntervals:0,maxExcessKw:0,totalExcessKwh:0,intervalIndexes:[]}),a.durationIntervals+=1,(e.excessKw>a.maxExcessKw||e.excessKw===a.maxExcessKw&&e.timestamp<a.peakTimestamp)&&(a.maxExcessKw=e.excessKw,a.peakTimestamp=e.timestamp),a.totalExcessKwh+=e.excessKwh,a.intervalIndexes.push(s)):a&&(t.push(a),a=null)}),a&&t.push(a),t}(r),c=function(e){var t,a;let{intervals:s,events:n,method:l,compliance:i,safetyFactor:r,efficiency:o}=e,c=0,d=0;if("MAX_PEAK"===l){let e=[...n].sort((e,t)=>t.totalExcessKwh-e.totalExcessKwh)[0];e&&(c=e.totalExcessKwh,d=e.maxExcessKw)}if("P95"===l){if(n.length<20){let e=[...n].sort((e,t)=>t.totalExcessKwh-e.totalExcessKwh)[0];e&&(c=e.totalExcessKwh,d=e.maxExcessKw)}else c=C(n.map(e=>e.totalExcessKwh),95),d=C(n.map(e=>e.maxExcessKw),95)}if("FULL_COVERAGE"===l){let e=new Map;s.forEach(t=>{var a;let s=t.timestamp.slice(0,10),n=null!==(a=e.get(s))&&void 0!==a?a:[];n.push(t),e.set(s,n)});let t=0,a=0;e.forEach(e=>{let s=e.reduce((e,t)=>e+t.excessKwh,0);s>t&&(t=s,a=Math.max(...e.map(e=>e.excessKw)))}),c=t,d=a}let m=(c*=i)/o*r,h=(d*=i)*r,u=null!==(t=T.find(e=>m<=e.capacityKwh))&&void 0!==t?t:T[T.length-1],p=T.findIndex(e=>e.capacityKwh===u.capacityKwh);return{kWhNeededRaw:c,kWNeededRaw:d,kWhNeeded:m,kWNeeded:h,recommendedProduct:u,alternativeProduct:null!==(a=T[p+1])&&void 0!==a?a:null}}({intervals:r,events:o,method:a.method,compliance:a.compliance,safetyFactor:a.safetyFactor,efficiency:a.efficiency}),d=function(e,t,a){let s=Math.max(0,...e.map(e=>e.excessKw));return T.map(a=>(function(e,t,a,s,n){var l,i,r,o;let c=null!==(i=null==n?void 0:n.powerCapKw)&&void 0!==i?i:a>0?a:Math.min(s,t/.5),d=null!==(r=null==n?void 0:n.initialSocRatio)&&void 0!==r?r:.5,m=Math.max(0,...e.map(e=>e.consumptionKw-e.excessKw)),h=t*d,u=0,p=0,x=0,v=0,w=0,g=new Map,f=e.map(e=>{var a;let s=e.timestamp.slice(0,10),n=null!==(a=g.get(s))&&void 0!==a?a:{before:0,after:0};g.set(s,n);let l=Math.max(0,m-e.consumptionKw);if(h=Math.min(t,h+.25*Math.min(l,c)*.95),e.excessKw>0){u+=1,x+=e.excessKwh,n.before+=e.excessKwh;let t=Math.min(.25*Math.min(e.excessKw,c),h);h-=t;let a=e.excessKw-t/.25;return a>0&&(p+=1,v+=.25*a,n.after+=.25*a),w=Math.max(w,a),{timestamp:e.timestamp,originalKw:e.consumptionKw,shavedKw:e.consumptionKw-t/.25}}return{timestamp:e.timestamp,originalKw:e.consumptionKw,shavedKw:e.consumptionKw}}),b=0===x?1:1-v/x,j=Array.from(g.values()).map(e=>{let{before:t,after:a}=e;return 0===t?1:1-a/t}),N=0===j.length?1:j.reduce((e,t)=>e+t,0)/j.length;return{optionLabel:null!==(o=null===(l=T.find(e=>e.capacityKwh===t))||void 0===l?void 0:l.label)&&void 0!==o?o:"".concat(t," kWh"),capacityKwh:t,exceedanceIntervalsBefore:u,exceedanceIntervalsAfter:p,exceedanceEnergyKwhBefore:x,exceedanceEnergyKwhAfter:v,achievedComplianceDataset:b,achievedComplianceDailyAverage:N,achievedCompliance:b,maxRemainingExcessKw:w,shavedSeries:f}})(e,a.capacityKwh,t,s,void 0))}(r,c.kWNeeded),{maxObservedKw:m,maxObservedTimestamp:h}=function(e){if(0===e.length)return{maxObservedKw:0,maxObservedTimestamp:null};let t=-1,a=null;return e.forEach(e=>{(e.consumptionKw>t||e.consumptionKw===t&&null!==a&&e.timestamp<a)&&(t=e.consumptionKw,a=e.timestamp)}),{maxObservedKw:t,maxObservedTimestamp:a}}(r),u=function(e){let t=new Map;e.forEach(e=>{var a;let s=e.timestamp.slice(0,10);t.set(s,(null!==(a=t.get(s))&&void 0!==a?a:0)+e.excessKw)});let a=null,s=-1;return t.forEach((e,t)=>{e>s&&(s=e,a=t)}),a}(r),p=u?function(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20;return e.filter(e=>e.timestamp.slice(0,10)===t&&e.excessKw>0).sort((e,t)=>t.excessKw-e.excessKw||e.timestamp.localeCompare(t.timestamp)).slice(0,a).map(e=>({timestamp:e.timestamp,consumption_kW:e.consumptionKw,excess_kW:e.excessKw}))}(r,u,20):[],x=function(e){var t,a,s,n;if(0===e.length)return{rows:0,startDate:null,endDate:null,missingIntervalsCount:0,duplicateCount:0,non15MinIntervals:0,warnings:["No rows found in dataset."]};let l=e.map(e=>new Date(e.timestamp)).filter(e=>!Number.isNaN(e.getTime())).sort((e,t)=>e.getTime()-t.getTime()),i=l.length-new Set(l.map(e=>e.toISOString())).size,r=0,o=0;for(let e=1;e<l.length;e+=1){let t=(l[e].getTime()-l[e-1].getTime())/6e4;15!==t&&(r+=1,t>15&&(o+=Math.max(0,Math.round(t/15)-1)))}let c=[];return i>0&&c.push("Detected ".concat(i," duplicate timestamps.")),r>0&&c.push("Detected ".concat(r," non-15-minute interval transitions.")),{rows:e.length,startDate:null!==(s=null===(t=l[0])||void 0===t?void 0:t.toISOString())&&void 0!==s?s:null,endDate:null!==(n=null===(a=l[l.length-1])||void 0===a?void 0:a.toISOString())&&void 0!==n?n:null,missingIntervalsCount:o,duplicateCount:i,non15MinIntervals:r,warnings:c}}(i.normalizedRows);return{intervals:r,events:o,sizing:c,scenarios:d,highestPeakDay:u,maxObservedKw:m,maxObservedTimestamp:h,topExceededIntervals:p,normalizationDiagnostics:i.diagnostics,quality:x}}(p,S,I);if(!e){$("Geen bruikbare rijen na normalisatie of filtering.");return}W({...I}),L({...S}),z(e),q(new Date().toISOString())},disabled:!G,children:"Analyze"}),(0,s.jsx)("button",{className:"rounded border border-slate-300 px-4 py-2 font-semibold text-slate-700 disabled:opacity-60",onClick:()=>{F&&P&&(_({...F}),U({...P}))},disabled:!J,children:"Reset changes"})]})]}),J&&(0,s.jsx)("p",{className:"rounded border border-amber-300 bg-amber-50 p-3 text-sm text-amber-800",children:"Changes not applied. Klik op Analyze om resultaten te verversen."}),R?(0,s.jsxs)(s.Fragment,{children:[R.maxObservedKw>1e4&&(0,s.jsx)("p",{className:"rounded border border-amber-300 bg-amber-50 p-3 text-amber-800",children:"Onrealistisch vermogen gedetecteerd - controleer kolomkeuze"}),(0,s.jsx)(K,{maxObservedKw:R.maxObservedKw,maxObservedTimestamp:R.maxObservedTimestamp,exceedanceIntervals:R.events.length,sizing:R.sizing}),(0,s.jsx)(N,{diagnostics:R.normalizationDiagnostics,quality:R.quality}),(0,s.jsx)(f,{intervals:R.intervals,contractKw:null!==(e=null==F?void 0:F.contractedPowerKw)&&void 0!==e?e:I.contractedPowerKw,topEvents:R.events,highestPeakDay:R.highestPeakDay,topExceededIntervals:R.topExceededIntervals}),(0,s.jsx)(E,{scenarios:R.scenarios,recommendedCapacityKwh:R.sizing.recommendedProduct.capacityKwh}),(0,s.jsx)(y,{scenarios:R.scenarios,selectedScenarioCapacity:B,onSelectScenario:H}),(0,s.jsxs)("div",{className:"rounded-lg border bg-white p-4",children:[(0,s.jsx)("h3",{className:"font-semibold",children:"Recommendation"}),(0,s.jsxs)("p",{children:["Recommended: ",R.sizing.recommendedProduct.label]}),(0,s.jsxs)("p",{children:["Alternative:"," ",R.sizing.alternativeProduct?R.sizing.alternativeProduct.label:"No larger product available"]}),V&&(0,s.jsxs)("p",{className:"mt-1 text-xs text-slate-500",children:["Last analyzed: ",V]}),(0,s.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:"Sizing for peak shaving; final engineering validation required."}),(0,s.jsx)("button",{className:"mt-3 rounded bg-emerald-600 px-4 py-2 font-semibold text-white disabled:opacity-60",onClick:Q,disabled:!R,children:"Download PDF report"})]})]}):(0,s.jsx)("div",{className:"rounded-lg border bg-white p-4 text-sm text-slate-600 shadow-sm",children:"Upload data and click Analyze to generate results."})]})}}},function(e){e.O(0,[425,456,971,117,744],function(){return e(e.s=2115)}),_N_E=e.O()}]);