(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{67:function(){},2061:function(){},2115:function(e,t,s){Promise.resolve().then(s.bind(s,9126))},9126:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return D}});var a=s(7437),n=s(2265),l=s(7625),i=s(6293),r=s(6940),o=s(7059),c=s(2994),d=s(8147),m=s(1699),h=s(4061),u=s(8556),p=s(407);let x=Date.UTC(1899,11,30);function g(e){if(e instanceof Date)return e;if("number"==typeof e&&Number.isFinite(e))return new Date(x+864e5*e);let t=String(null!=e?e:"").trim();if(!t)return new Date(Number.NaN);let s=Number(t);return new Date(Number.isFinite(s)&&/^\d+(\.\d+)?$/.test(t)?x+864e5*s:t)}function v(e){let t="string"==typeof e?g(e):e;if(Number.isNaN(t.getTime()))return"-";let s=Object.fromEntries(new Intl.DateTimeFormat("nl-NL",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1,timeZone:"Europe/Amsterdam"}).formatToParts(t).map(e=>[e.type,e.value]));return"".concat(s.day,"-").concat(s.month,"-").concat(s.year," ").concat(s.hour,":").concat(s.minute)}function w(e){var t;let{intervals:s,contractKw:n,topEvents:x,highestPeakDay:g,topExceededIntervals:w}=e,b=null!=g?g:null===(t=s[0])||void 0===t?void 0:t.timestamp.slice(0,10),f=new Set(w.map(e=>e.timestamp)),j=s.filter(e=>e.timestamp.slice(0,10)===b).map(e=>({...e,contractKw:n,isTopExceeded:f.has(e.timestamp)})),N=Math.max(1,...s.map(e=>e.consumptionKw))/20,K=Array.from({length:20},(e,t)=>{let a=t*N,l=a+N,i=s.filter(e=>e.consumptionKw>=a&&(19===t?e.consumptionKw<=l:e.consumptionKw<l)).length,r="".concat(a.toFixed(0),"-").concat(l.toFixed(0)),o=l/n;return{label:r,count:i,bucketType:o>1?"over100":o>.9?"over90":"normal"}});return(0,a.jsxs)("div",{className:"grid gap-4 lg:grid-cols-2",children:[(0,a.jsxs)("div",{className:"rounded-lg border bg-white p-4",children:[(0,a.jsx)("h3",{className:"mb-2 font-semibold",children:"Highest Peak Day Profile"}),(0,a.jsx)("div",{className:"h-64",children:(0,a.jsx)(l.h,{children:(0,a.jsxs)(i.c,{data:j,children:[(0,a.jsx)(r.q,{strokeDasharray:"3 3"}),(0,a.jsx)(o.K,{dataKey:"timestamp",hide:!0}),(0,a.jsx)(c.B,{}),(0,a.jsx)(d.u,{}),(0,a.jsx)(m.$,{dataKey:"consumptionKw",fill:"#3b82f6"}),(0,a.jsx)(h.x,{type:"monotone",dataKey:"contractKw",stroke:"#ef4444",dot:!1}),j.filter(e=>e.isTopExceeded).map(e=>(0,a.jsx)(u.q,{x:e.timestamp,y:e.consumptionKw,r:4,fill:"#ef4444",stroke:"#7f1d1d"},e.timestamp))]})})}),(0,a.jsx)("div",{className:"mt-3 max-h-40 overflow-y-auto rounded border",children:(0,a.jsxs)("table",{className:"min-w-full text-xs",children:[(0,a.jsx)("thead",{className:"sticky top-0 bg-slate-50",children:(0,a.jsxs)("tr",{className:"border-b text-left",children:[(0,a.jsx)("th",{className:"p-2",children:"Timestamp"}),(0,a.jsx)("th",{className:"p-2",children:"Consumption kW"}),(0,a.jsx)("th",{className:"p-2",children:"Excess kW"})]})}),(0,a.jsx)("tbody",{children:w.map(e=>(0,a.jsxs)("tr",{className:"border-b",children:[(0,a.jsx)("td",{className:"p-2",children:v(e.timestamp)}),(0,a.jsx)("td",{className:"p-2",children:e.consumption_kW.toFixed(2)}),(0,a.jsx)("td",{className:"p-2",children:e.excess_kW.toFixed(2)})]},e.timestamp))})]})})]}),(0,a.jsxs)("div",{className:"rounded-lg border bg-white p-4",children:[(0,a.jsx)("h3",{className:"mb-2 font-semibold",children:"Consumption Histogram"}),(0,a.jsx)("div",{className:"h-64",children:(0,a.jsx)(l.h,{children:(0,a.jsxs)(i.c,{data:K,children:[(0,a.jsx)(r.q,{strokeDasharray:"3 3"}),(0,a.jsx)(o.K,{dataKey:"label",hide:!0}),(0,a.jsx)(c.B,{}),(0,a.jsx)(d.u,{}),(0,a.jsx)(m.$,{dataKey:"count",children:K.map((e,t)=>(0,a.jsx)(p.b,{fill:"over100"===e.bucketType?"#dc2626":"over90"===e.bucketType?"#f59e0b":"#10b981"},"cell-".concat(t)))})]})})})]}),(0,a.jsxs)("div",{className:"rounded-lg border bg-white p-4 lg:col-span-2",children:[(0,a.jsx)("h3",{className:"mb-2 font-semibold",children:"Top 10 Peak Events"}),(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"min-w-full text-sm",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{className:"border-b text-left",children:[(0,a.jsx)("th",{className:"p-2",children:"Peak timestamp"}),(0,a.jsx)("th",{className:"p-2",children:"Duration"}),(0,a.jsx)("th",{className:"p-2",children:"Max excess kW"}),(0,a.jsx)("th",{className:"p-2",children:"Total excess kWh"})]})}),(0,a.jsx)("tbody",{children:x.slice(0,10).map(e=>(0,a.jsxs)("tr",{className:"border-b",children:[(0,a.jsx)("td",{className:"p-2",children:v(e.peakTimestamp)}),(0,a.jsx)("td",{className:"p-2",children:e.durationIntervals}),(0,a.jsx)("td",{className:"p-2",children:e.maxExcessKw.toFixed(2)}),(0,a.jsx)("td",{className:"p-2",children:e.totalExcessKwh.toFixed(2)})]},"".concat(e.peakTimestamp,"-").concat(e.durationIntervals)))})]})})]})]})}function b(e){let{headers:t,mapping:s,onChange:n}=e,l=(e,t)=>{n({...s,[e]:t})};return(0,a.jsxs)("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[(0,a.jsx)("h2",{className:"mb-2 font-semibold",children:"Column Mapping"}),(0,a.jsx)("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[["timestamp","timestamp"],["consumptionKwh","consumption_kwh"],["exportKwh","export_kwh (optional)"],["pvKwh","pv_kwh (optional)"]].map(e=>{var n;let[i,r]=e;return(0,a.jsxs)("label",{className:"text-sm",children:[r,(0,a.jsxs)("select",{className:"mt-1 w-full rounded border p-2",value:null!==(n=s[i])&&void 0!==n?n:"",onChange:e=>l(i,e.target.value),children:[(0,a.jsx)("option",{value:"",children:"Select column"}),t.map(e=>(0,a.jsx)("option",{value:e,children:e},e))]})]},i)})})]})}function f(e){let{compliance:t,onChange:s}=e;return(0,a.jsxs)("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("label",{className:"font-semibold",children:"Compliance target"}),(0,a.jsxs)("span",{className:"text-sm",children:[Math.round(100*t),"%"]})]}),(0,a.jsx)("input",{className:"mt-3 w-full",type:"range",min:70,max:100,step:1,value:Math.round(100*t),onChange:e=>s(Number(e.target.value)/100)}),(0,a.jsx)("p",{className:"mt-2 text-xs text-slate-600",children:"Compliance = target percentage of peak exceedance to shave."})]})}function j(e){let{diagnostics:t,quality:s}=e,n="AUTO"===t.interpretationRequested?"AUTO -> ".concat(t.interpretationUsed):t.interpretationUsed;return(0,a.jsxs)("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[(0,a.jsx)("h3",{className:"font-semibold",children:"Data quality"}),(0,a.jsxs)("div",{className:"mt-2 grid gap-2 text-sm md:grid-cols-2",children:[(0,a.jsxs)("p",{children:["Interpretatie: ",n]}),(0,a.jsxs)("p",{children:["Rijen totaal/gebruikt: ",t.rowsTotal," / ",t.rowsUsed]}),(0,a.jsxs)("p",{children:["Missing intervals: ",s.missingIntervalsCount]}),(0,a.jsxs)("p",{children:["Outliers uitgesloten: ",t.countOutliers,t.firstOutlierTimestamp?" (eerste: ".concat(v(t.firstOutlierTimestamp),")"):""]}),(0,a.jsxs)("p",{children:["Negatieve deltas: ",t.negativeDeltaCount]})]})]})}function N(e){let{maxObservedKw:t,maxObservedTimestamp:s,exceedanceIntervals:n,sizing:l}=e,i=[{label:"Max observed kW",value:t.toFixed(2),subtext:s?v(s):"-"},{label:"Exceedance intervals",value:String(n)},{label:"kWh needed",value:l.kWhNeeded.toFixed(2)},{label:"kW needed",value:l.kWNeeded.toFixed(2)},{label:"Recommended",value:l.recommendedProduct.capacityKwh+" kWh"}];return(0,a.jsx)("div",{className:"grid grid-cols-2 gap-3 lg:grid-cols-5",children:i.map(e=>(0,a.jsxs)("div",{className:"rounded-lg border bg-white p-3 shadow-sm",children:[(0,a.jsx)("div",{className:"text-xs text-slate-500",children:e.label}),(0,a.jsx)("div",{className:"text-lg font-semibold",children:e.value}),"subtext"in e&&e.subtext?(0,a.jsx)("div",{className:"text-xs text-slate-500",children:e.subtext}):null]},e.label))})}function K(e){var t,s,n;let{scenarios:u,selectedScenarioCapacity:p,onSelectScenario:x}=e,g=null!==(s=u.find(e=>e.capacityKwh===p))&&void 0!==s?s:u[0],v=null==g?void 0:null===(t=g.shavedSeries[0])||void 0===t?void 0:t.timestamp.slice(0,10),w=null!==(n=null==g?void 0:g.shavedSeries.filter(e=>e.timestamp.slice(0,10)===v))&&void 0!==n?n:[];return(0,a.jsxs)("div",{className:"grid gap-4 lg:grid-cols-2",children:[(0,a.jsxs)("div",{className:"rounded-lg border bg-white p-4",children:[(0,a.jsx)("h3",{className:"mb-2 font-semibold",children:"Exceedance energy before/after"}),(0,a.jsx)("div",{className:"h-64",children:(0,a.jsx)(l.h,{children:(0,a.jsxs)(i.c,{data:u,children:[(0,a.jsx)(r.q,{strokeDasharray:"3 3"}),(0,a.jsx)(o.K,{dataKey:"capacityKwh"}),(0,a.jsx)(c.B,{}),(0,a.jsx)(d.u,{}),(0,a.jsx)(m.$,{dataKey:"exceedanceEnergyKwhBefore",fill:"#f97316",name:"Before"}),(0,a.jsx)(m.$,{dataKey:"exceedanceEnergyKwhAfter",fill:"#3b82f6",name:"After"})]})})})]}),(0,a.jsxs)("div",{className:"rounded-lg border bg-white p-4",children:[(0,a.jsxs)("div",{className:"mb-2 flex items-center justify-between",children:[(0,a.jsx)("h3",{className:"font-semibold",children:"Highest peak day overlay"}),(0,a.jsx)("select",{value:p,onChange:e=>x(Number(e.target.value)),className:"rounded border p-1 text-sm",children:u.map(e=>(0,a.jsxs)("option",{value:e.capacityKwh,children:[e.capacityKwh," kWh"]},e.capacityKwh))})]}),(0,a.jsx)("div",{className:"h-64",children:(0,a.jsx)(l.h,{children:(0,a.jsxs)(i.c,{data:w,children:[(0,a.jsx)(r.q,{strokeDasharray:"3 3"}),(0,a.jsx)(o.K,{dataKey:"timestamp",hide:!0}),(0,a.jsx)(c.B,{}),(0,a.jsx)(d.u,{}),(0,a.jsx)(h.x,{dataKey:"originalKw",stroke:"#ef4444",dot:!1,name:"Original"}),(0,a.jsx)(h.x,{dataKey:"shavedKw",stroke:"#10b981",dot:!1,name:"Shaved"})]})})})]})]})}function y(e){let{scenarios:t,recommendedCapacityKwh:s}=e;return(0,a.jsxs)("div",{className:"rounded-lg border bg-white p-4",children:[(0,a.jsx)("h3",{className:"mb-2 font-semibold",children:"Multi-battery scenario comparison"}),(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"min-w-full text-sm",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{className:"border-b text-left",children:[(0,a.jsx)("th",{className:"p-2",children:"Option"}),(0,a.jsx)("th",{className:"p-2",children:"Before kWh"}),(0,a.jsx)("th",{className:"p-2",children:"After kWh"}),(0,a.jsx)("th",{className:"p-2",children:"Dataset compliance"}),(0,a.jsx)("th",{className:"p-2",children:"Daily avg compliance"}),(0,a.jsx)("th",{className:"p-2",children:"Remaining max kW"})]})}),(0,a.jsx)("tbody",{children:t.map(e=>(0,a.jsxs)("tr",{className:"border-b ".concat(e.capacityKwh===s?"bg-emerald-50":""),children:[(0,a.jsx)("td",{className:"p-2",children:e.optionLabel}),(0,a.jsx)("td",{className:"p-2",children:e.exceedanceEnergyKwhBefore.toFixed(2)}),(0,a.jsx)("td",{className:"p-2",children:e.exceedanceEnergyKwhAfter.toFixed(2)}),(0,a.jsxs)("td",{className:"p-2",children:[(100*e.achievedComplianceDataset).toFixed(1),"%"]}),(0,a.jsxs)("td",{className:"p-2",children:[(100*e.achievedComplianceDailyAverage).toFixed(1),"%"]}),(0,a.jsx)("td",{className:"p-2",children:e.maxRemainingExcessKw.toFixed(2)})]},e.capacityKwh))})]})})]})}function E(e){let{onFile:t}=e;return(0,a.jsxs)("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[(0,a.jsx)("label",{className:"mb-2 block text-sm font-medium",children:"Upload CSV or XLSX"}),(0,a.jsx)("input",{type:"file",accept:".csv,.xlsx",onChange:e=>{var s;let a=null===(s=e.target.files)||void 0===s?void 0:s[0];a&&t(a)}})]})}let k=[{label:"WattsNext ESS Cabinet 64 kWh",capacityKwh:64},{label:"WattsNext ESS Cabinet 96 kWh",capacityKwh:96},{label:"ESS All-in-one Cabinet 261 kWh",capacityKwh:261},{label:"WattsNext All-in-one Container 2.09 MWh",capacityKwh:2090},{label:"WattsNext All in-one Container 5.01 MWh",capacityKwh:5010}];function T(e,t){if(0===e.length)return 0;let s=[...e].sort((e,t)=>e-t),a=Math.ceil(t/100*s.length)-1;return s[Math.max(0,Math.min(a,s.length-1))]}var C=s(5452),M=s.n(C),S=s(2093);function A(e){var t,s,a,n;let l=new Map(e.map(e=>[e.trim().toLowerCase(),e])),i=null!==(s=null!==(t=l.get("timestamp"))&&void 0!==t?t:l.get("date"))&&void 0!==s?s:l.get("datetime"),r=null!==(n=null!==(a=l.get("consumption_kwh"))&&void 0!==a?a:l.get("consumption"))&&void 0!==n?n:l.get("load_kwh");return i&&r?{timestamp:i,consumptionKwh:r,exportKwh:l.get("export_kwh"),pvKwh:l.get("pv_kwh")}:null}function D(){let[e,t]=(0,n.useState)([]),[s,l]=(0,n.useState)([]),[i,r]=(0,n.useState)({timestamp:"",consumptionKwh:""}),[o,c]=(0,n.useState)(500),[d,m]=(0,n.useState)("MAX_PEAK"),[h,u]=(0,n.useState)(1.2),[p,x]=(0,n.useState)(.9),[v,C]=(0,n.useState)(.95),[D,O]=(0,n.useState)(!1),[U,L]=(0,n.useState)(64),[I,_]=(0,n.useState)("AUTO"),[W,P]=(0,n.useState)(null),R=(0,n.useMemo)(()=>i.timestamp&&i.consumptionKwh?function(e,t){let s=[];return e.forEach(e=>{let a=e[t.timestamp],n=e[t.consumptionKwh],l=t.exportKwh?e[t.exportKwh]:void 0,i=t.pvKwh?e[t.pvKwh]:void 0,r=g(a),o=Number(n);Number.isNaN(r.getTime())||Number.isNaN(o)||s.push({timestamp:r.toISOString(),consumptionKwh:o,exportKwh:null==l?void 0:Number(l),pvKwh:null==i?void 0:Number(i)})}),s.sort((e,t)=>e.timestamp.localeCompare(t.timestamp))}(e,i):[],[i,e]),F=(0,n.useMemo)(()=>0===R.length?null:function(e){var t,s,a,n,l;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=(null!==(t=i.intervalMinutes)&&void 0!==t?t:15)/60,o=null!==(s=i.interpretationMode)&&void 0!==s?s:"AUTO",c=null!==(a=i.outlierKwThreshold)&&void 0!==a?a:5e3,d=null!==(n=i.allowNegativeDeltas)&&void 0!==n&&n,m=null!==(l=i.hugeKwhThreshold)&&void 0!==l?l:1e3,h=[],u=[];e.forEach(e=>{let t=g(e.timestamp),s=Number(e.consumptionKwh);Number.isNaN(t.getTime())||Number.isNaN(s)||u.push({timestamp:t.toISOString(),consumptionKwh:s,exportKwh:e.exportKwh,pvKwh:e.pvKwh})}),u.sort((e,t)=>e.timestamp.localeCompare(t.timestamp));let p=function(e,t,s){if(e.length<2)return{interpretationUsed:"CUMULATIVE_DELTA"===t?"CUMULATIVE_DELTA":"INTERVAL",fractionNonDecreasing:0,medianDelta:0,fractionHugeValues:1===e.length&&e[0]>s?1:0};let a=0,n=[],l=0;for(let t=0;t<e.length;t+=1)if(e[t]>s&&(l+=1),t>0){let s=e[t]-e[t-1];n.push(s),e[t]>=e[t-1]&&(a+=1)}let i=a/(e.length-1),r=function(e){if(0===e.length)return 0;let t=[...e].sort((e,t)=>e-t),s=Math.floor(t.length/2);return t.length%2==0?(t[s-1]+t[s])/2:t[s]}(n),o=l/e.length;return"INTERVAL"===t?{interpretationUsed:"INTERVAL",fractionNonDecreasing:i,medianDelta:r,fractionHugeValues:o}:"CUMULATIVE_DELTA"===t?{interpretationUsed:"CUMULATIVE_DELTA",fractionNonDecreasing:i,medianDelta:r,fractionHugeValues:o}:{interpretationUsed:i>.98&&r>=0||o>.001?"CUMULATIVE_DELTA":"INTERVAL",fractionNonDecreasing:i,medianDelta:r,fractionHugeValues:o}}(u.map(e=>e.consumptionKwh),o,m),x=0,v=0,w=null,b=null,f=[];for(let e=0;e<u.length;e+=1){let t=u[e],s=t.consumptionKwh;if("CUMULATIVE_DELTA"===p.interpretationUsed){if(0===e)s=0;else{let a=t.consumptionKwh-u[e-1].consumptionKwh;a<0&&!d?(x+=1,s=0):s=a}}if(s<0)continue;let a=s/r;if(a>c){v+=1,w=null==w?a:Math.max(w,a),b=null!=b?b:t.timestamp;continue}f.push({...t,consumptionKwh:s})}return x>0&&h.push("".concat(x," negatieve delta(s) zijn op 0 gezet.")),v>0&&h.push("".concat(v," outlier(s) boven ").concat(c," kW uitgesloten.")),{normalizedRows:f,diagnostics:{interpretationRequested:o,interpretationUsed:p.interpretationUsed,rowsTotal:e.length,rowsUsed:f.length,invalidRows:e.length-u.length,countOutliers:v,maxOutlierKw:w,firstOutlierTimestamp:b,negativeDeltaCount:x,fractionNonDecreasing:p.fractionNonDecreasing,medianDelta:p.medianDelta,fractionHugeValues:p.fractionHugeValues,warnings:h}}}(R,{intervalMinutes:15,interpretationMode:I,outlierKwThreshold:5e3,allowNegativeDeltas:!1}),[I,R]),V=!!i.timestamp&&!!i.consumptionKwh&&!!F&&F.normalizedRows.length>0,z=(0,n.useMemo)(()=>{if(!D||!F||0===F.normalizedRows.length)return null;let e=F.normalizedRows.map(e=>{let t=g(e.timestamp),s=Number.isNaN(t.getTime())?e.timestamp:t.toISOString(),a=e.consumptionKwh/.25,n=Math.max(0,a-o);return{...e,timestamp:s,consumptionKw:a,excessKw:n,excessKwh:.25*n}}),t=function(e){let t=[],s=null;return e.forEach((e,a)=>{e.excessKw>0?(s||(s={peakTimestamp:e.timestamp,durationIntervals:0,maxExcessKw:0,totalExcessKwh:0,intervalIndexes:[]}),s.durationIntervals+=1,(e.excessKw>s.maxExcessKw||e.excessKw===s.maxExcessKw&&e.timestamp<s.peakTimestamp)&&(s.maxExcessKw=e.excessKw,s.peakTimestamp=e.timestamp),s.totalExcessKwh+=e.excessKwh,s.intervalIndexes.push(a)):s&&(t.push(s),s=null)}),s&&t.push(s),t}(e),s=function(e){var t,s;let{intervals:a,events:n,method:l,compliance:i,safetyFactor:r,efficiency:o}=e,c=0,d=0;if("MAX_PEAK"===l){let e=[...n].sort((e,t)=>t.totalExcessKwh-e.totalExcessKwh)[0];e&&(c=e.totalExcessKwh,d=e.maxExcessKw)}if("P95"===l){if(n.length<20){let e=[...n].sort((e,t)=>t.totalExcessKwh-e.totalExcessKwh)[0];e&&(c=e.totalExcessKwh,d=e.maxExcessKw)}else c=T(n.map(e=>e.totalExcessKwh),95),d=T(n.map(e=>e.maxExcessKw),95)}if("FULL_COVERAGE"===l){let e=new Map;a.forEach(t=>{var s;let a=t.timestamp.slice(0,10),n=null!==(s=e.get(a))&&void 0!==s?s:[];n.push(t),e.set(a,n)});let t=0,s=0;e.forEach(e=>{let a=e.reduce((e,t)=>e+t.excessKwh,0);a>t&&(t=a,s=Math.max(...e.map(e=>e.excessKw)))}),c=t,d=s}let m=(c*=i)/o*r,h=(d*=i)*r,u=null!==(t=k.find(e=>m<=e.capacityKwh))&&void 0!==t?t:k[k.length-1],p=k.findIndex(e=>e.capacityKwh===u.capacityKwh);return{kWhNeededRaw:c,kWNeededRaw:d,kWhNeeded:m,kWNeeded:h,recommendedProduct:u,alternativeProduct:null!==(s=k[p+1])&&void 0!==s?s:null}}({intervals:e,events:t,method:d,compliance:v,safetyFactor:h,efficiency:p}),a=function(e,t,s){let a=Math.max(0,...e.map(e=>e.excessKw));return k.map(s=>(function(e,t,s,a,n){var l,i,r,o;let c=null!==(i=null==n?void 0:n.powerCapKw)&&void 0!==i?i:s>0?s:Math.min(a,t/.5),d=null!==(r=null==n?void 0:n.initialSocRatio)&&void 0!==r?r:.5,m=Math.max(0,...e.map(e=>e.consumptionKw-e.excessKw)),h=t*d,u=0,p=0,x=0,g=0,v=0,w=new Map,b=e.map(e=>{var s;let a=e.timestamp.slice(0,10),n=null!==(s=w.get(a))&&void 0!==s?s:{before:0,after:0};w.set(a,n);let l=Math.max(0,m-e.consumptionKw);if(h=Math.min(t,h+.25*Math.min(l,c)*.95),e.excessKw>0){u+=1,x+=e.excessKwh,n.before+=e.excessKwh;let t=Math.min(.25*Math.min(e.excessKw,c),h);h-=t;let s=e.excessKw-t/.25;return s>0&&(p+=1,g+=.25*s,n.after+=.25*s),v=Math.max(v,s),{timestamp:e.timestamp,originalKw:e.consumptionKw,shavedKw:e.consumptionKw-t/.25}}return{timestamp:e.timestamp,originalKw:e.consumptionKw,shavedKw:e.consumptionKw}}),f=0===x?1:1-g/x,j=Array.from(w.values()).map(e=>{let{before:t,after:s}=e;return 0===t?1:1-s/t}),N=0===j.length?1:j.reduce((e,t)=>e+t,0)/j.length;return{optionLabel:null!==(o=null===(l=k.find(e=>e.capacityKwh===t))||void 0===l?void 0:l.label)&&void 0!==o?o:"".concat(t," kWh"),capacityKwh:t,exceedanceIntervalsBefore:u,exceedanceIntervalsAfter:p,exceedanceEnergyKwhBefore:x,exceedanceEnergyKwhAfter:g,achievedComplianceDataset:f,achievedComplianceDailyAverage:N,achievedCompliance:f,maxRemainingExcessKw:v,shavedSeries:b}})(e,s.capacityKwh,t,a,void 0))}(e,s.kWNeeded),{maxObservedKw:n,maxObservedTimestamp:l}=function(e){if(0===e.length)return{maxObservedKw:0,maxObservedTimestamp:null};let t=-1,s=null;return e.forEach(e=>{(e.consumptionKw>t||e.consumptionKw===t&&null!==s&&e.timestamp<s)&&(t=e.consumptionKw,s=e.timestamp)}),{maxObservedKw:t,maxObservedTimestamp:s}}(e),i=function(e){let t=new Map;e.forEach(e=>{var s;let a=e.timestamp.slice(0,10);t.set(a,(null!==(s=t.get(a))&&void 0!==s?s:0)+e.excessKw)});let s=null,a=-1;return t.forEach((e,t)=>{e>a&&(a=e,s=t)}),s}(e),r=i?function(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20;return e.filter(e=>e.timestamp.slice(0,10)===t&&e.excessKw>0).sort((e,t)=>t.excessKw-e.excessKw||e.timestamp.localeCompare(t.timestamp)).slice(0,s).map(e=>({timestamp:e.timestamp,consumption_kW:e.consumptionKw,excess_kW:e.excessKw}))}(e,i,20):[],c=function(e){var t,s,a,n;if(0===e.length)return{rows:0,startDate:null,endDate:null,missingIntervalsCount:0,duplicateCount:0,non15MinIntervals:0,warnings:["No rows found in dataset."]};let l=e.map(e=>new Date(e.timestamp)).filter(e=>!Number.isNaN(e.getTime())).sort((e,t)=>e.getTime()-t.getTime()),i=l.length-new Set(l.map(e=>e.toISOString())).size,r=0,o=0;for(let e=1;e<l.length;e+=1){let t=(l[e].getTime()-l[e-1].getTime())/6e4;15!==t&&(r+=1,t>15&&(o+=Math.max(0,Math.round(t/15)-1)))}let c=[];return i>0&&c.push("Detected ".concat(i," duplicate timestamps.")),r>0&&c.push("Detected ".concat(r," non-15-minute interval transitions.")),{rows:e.length,startDate:null!==(a=null===(t=l[0])||void 0===t?void 0:t.toISOString())&&void 0!==a?a:null,endDate:null!==(n=null===(s=l[l.length-1])||void 0===s?void 0:s.toISOString())&&void 0!==n?n:null,missingIntervalsCount:o,duplicateCount:i,non15MinIntervals:r,warnings:c}}(F.normalizedRows);return{intervals:e,events:t,sizing:s,scenarios:a,highestPeakDay:i,maxObservedKw:n,maxObservedTimestamp:l,topExceededIntervals:r,normalizationDiagnostics:F.diagnostics,quality:c}},[D,v,o,p,d,F,h]),q=async e=>{P(null);try{if(e.name.toLowerCase().endsWith(".csv")){let s=await e.text(),a=function(e){var t;let s=M().parse(e,{header:!0,skipEmptyLines:!0});if(s.errors.length>0)throw Error("CSV parsing failed: ".concat(s.errors[0].message));let a=null!==(t=s.meta.fields)&&void 0!==t?t:[];return{rows:s.data,headers:a}}(s);t(a.rows),l(a.headers);let n=A(a.headers);n&&r(n)}else{let s=await e.arrayBuffer(),a=function(e){let t=S.ij(e,{type:"array"}),s=t.Sheets[t.SheetNames[0]],a=S.P6.sheet_to_json(s,{defval:null}),n=a.length>0?Object.keys(a[0]):[];return{rows:a,headers:n}}(s);t(a.rows),l(a.headers);let n=A(a.headers);n&&r(n)}O(!1)}catch(e){P(e instanceof Error?e.message:"Could not parse file")}},B=async()=>{if(!z)return;let e=await fetch("/api/report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contractedPowerKw:o,maxObservedKw:z.maxObservedKw,maxObservedTimestamp:z.maxObservedTimestamp,exceedanceCount:z.events.length,compliance:v,method:d,efficiency:p,safetyFactor:h,sizing:z.sizing,quality:z.quality,topEvents:z.events,scenarios:z.scenarios})}),t=await e.blob(),s=URL.createObjectURL(t),a=document.createElement("a");a.href=s,a.download="peak-shaving-report.pdf",a.click(),URL.revokeObjectURL(s)};return(0,a.jsxs)("main",{className:"mx-auto max-w-7xl space-y-4 p-4",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold",children:"Peak Shaving Advisor (MVP)"}),(0,a.jsx)("p",{className:"text-sm text-slate-600",children:"Upload 15-minute interval data and generate a battery advice report."}),(0,a.jsx)(E,{onFile:q}),W&&(0,a.jsx)("p",{className:"rounded border border-red-200 bg-red-50 p-3 text-red-700",children:W}),s.length>0&&(0,a.jsx)(b,{headers:s,mapping:i,onChange:r}),(0,a.jsxs)("div",{className:"grid gap-4 rounded-lg border bg-white p-4 shadow-sm lg:grid-cols-3",children:[(0,a.jsxs)("label",{className:"text-sm",children:["Contracted power (kW)",(0,a.jsx)("input",{className:"mt-1 w-full rounded border p-2",type:"number",value:o,onChange:e=>c(Number(e.target.value))})]}),(0,a.jsxs)("label",{className:"text-sm",children:["Method",(0,a.jsxs)("select",{className:"mt-1 w-full rounded border p-2",value:d,onChange:e=>m(e.target.value),children:[(0,a.jsx)("option",{value:"MAX_PEAK",children:"MAX_PEAK"}),(0,a.jsx)("option",{value:"P95",children:"P95"}),(0,a.jsx)("option",{value:"FULL_COVERAGE",children:"FULL_COVERAGE"})]})]}),(0,a.jsxs)("label",{className:"text-sm",children:["Interpretation",(0,a.jsxs)("select",{className:"mt-1 w-full rounded border p-2",value:I,onChange:e=>_(e.target.value),children:[(0,a.jsx)("option",{value:"AUTO",children:"Auto"}),(0,a.jsx)("option",{value:"INTERVAL",children:"Interval values"}),(0,a.jsx)("option",{value:"CUMULATIVE_DELTA",children:"Cumulative meter readings (delta)"})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,a.jsxs)("label",{className:"text-sm",children:["Safety factor",(0,a.jsx)("input",{className:"mt-1 w-full rounded border p-2",type:"number",step:"0.01",value:h,onChange:e=>u(Number(e.target.value))})]}),(0,a.jsxs)("label",{className:"text-sm",children:["Efficiency",(0,a.jsx)("input",{className:"mt-1 w-full rounded border p-2",type:"number",step:"0.01",value:p,onChange:e=>x(Number(e.target.value))})]})]}),(0,a.jsx)("div",{className:"lg:col-span-3",children:(0,a.jsx)(f,{compliance:v,onChange:C})}),(0,a.jsx)("button",{className:"rounded bg-blue-600 px-4 py-2 font-semibold text-white hover:bg-blue-700",onClick:()=>O(!0),disabled:!V,children:"Analyze"})]}),z&&(0,a.jsxs)(a.Fragment,{children:[z.maxObservedKw>1e4&&(0,a.jsx)("p",{className:"rounded border border-amber-300 bg-amber-50 p-3 text-amber-800",children:"Onrealistisch vermogen gedetecteerd - controleer kolomkeuze"}),(0,a.jsx)(N,{maxObservedKw:z.maxObservedKw,maxObservedTimestamp:z.maxObservedTimestamp,exceedanceIntervals:z.events.length,sizing:z.sizing}),(0,a.jsx)(j,{diagnostics:z.normalizationDiagnostics,quality:z.quality}),(0,a.jsx)(w,{intervals:z.intervals,contractKw:o,topEvents:z.events,highestPeakDay:z.highestPeakDay,topExceededIntervals:z.topExceededIntervals}),(0,a.jsx)(y,{scenarios:z.scenarios,recommendedCapacityKwh:z.sizing.recommendedProduct.capacityKwh}),(0,a.jsx)(K,{scenarios:z.scenarios,selectedScenarioCapacity:U,onSelectScenario:L}),(0,a.jsxs)("div",{className:"rounded-lg border bg-white p-4",children:[(0,a.jsx)("h3",{className:"font-semibold",children:"Recommendation"}),(0,a.jsxs)("p",{children:["Recommended: ",z.sizing.recommendedProduct.label]}),(0,a.jsxs)("p",{children:["Alternative:"," ",z.sizing.alternativeProduct?z.sizing.alternativeProduct.label:"No larger product available"]}),(0,a.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:"Sizing for peak shaving; final engineering validation required."}),(0,a.jsx)("button",{className:"mt-3 rounded bg-emerald-600 px-4 py-2 font-semibold text-white",onClick:B,children:"Download PDF report"})]})]})]})}}},function(e){e.O(0,[425,456,971,117,744],function(){return e(e.s=2115)}),_N_E=e.O()}]);