"use strict";(()=>{var e={};e.id=652,e.ids=[652],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6272:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>x,patchFetch:()=>d,requestAsyncStorage:()=>u,routeModule:()=>h,serverHooks:()=>w,staticGenerationAsyncStorage:()=>m});var n={};a.r(n),a.d(n,{POST:()=>p});var s=a(9303),i=a(8716),r=a(670),l=a(7070);let o=[{label:"WattsNext ESS Cabinet 64 kWh",capacityKwh:64},{label:"WattsNext ESS Cabinet 96 kWh",capacityKwh:96},{label:"ESS All-in-one Cabinet 261 kWh",capacityKwh:261},{label:"WattsNext All-in-one Container 2.09 MWh",capacityKwh:2090},{label:"WattsNext All in-one Container 5.01 MWh",capacityKwh:5010}];function c(e,t){if(0===e.length)return 0;let a=[...e].sort((e,t)=>e-t),n=Math.ceil(t/100*a.length)-1;return a[Math.max(0,Math.min(n,a.length-1))]}async function p(e){var t,a;let n=await e.json(),s=(t=n.rows,a=n.contractedPowerKw,t.map(e=>{let t=e.consumptionKwh/.25,n=Math.max(0,t-a);return{...e,consumptionKw:t,excessKw:n,excessKwh:.25*n}})),i=function(e){let t=[],a=null;return e.forEach((e,n)=>{e.excessKw>0?(a||(a={start:e.timestamp,end:e.timestamp,durationIntervals:0,maxExcessKw:0,totalExcessKwh:0,intervalIndexes:[]}),a.end=e.timestamp,a.durationIntervals+=1,a.maxExcessKw=Math.max(a.maxExcessKw,e.excessKw),a.totalExcessKwh+=e.excessKwh,a.intervalIndexes.push(n)):a&&(t.push(a),a=null)}),a&&t.push(a),t}(s),r=function(e){let{intervals:t,events:a,method:n,compliance:s,safetyFactor:i,efficiency:r}=e,l=0,p=0;if("MAX_PEAK"===n){let e=[...a].sort((e,t)=>t.totalExcessKwh-e.totalExcessKwh)[0];e&&(l=e.totalExcessKwh,p=e.maxExcessKw)}if("P95"===n){if(a.length<20){let e=[...a].sort((e,t)=>t.totalExcessKwh-e.totalExcessKwh)[0];e&&(l=e.totalExcessKwh,p=e.maxExcessKw)}else l=c(a.map(e=>e.totalExcessKwh),95),p=c(a.map(e=>e.maxExcessKw),95)}if("FULL_COVERAGE"===n){let e=new Map;t.forEach(t=>{let a=t.timestamp.slice(0,10),n=e.get(a)??[];n.push(t),e.set(a,n)});let a=0,n=0;e.forEach(e=>{let t=e.reduce((e,t)=>e+t.excessKwh,0);t>a&&(a=t,n=Math.max(...e.map(e=>e.excessKw)))}),l=a,p=n}let h=(l*=s)/r*i,u=(p*=s)*i,m=o.find(e=>h<=e.capacityKwh)??o[o.length-1],w=o.findIndex(e=>e.capacityKwh===m.capacityKwh);return{kWhNeededRaw:l,kWNeededRaw:p,kWhNeeded:h,kWNeeded:u,recommendedProduct:m,alternativeProduct:o[w+1]??null}}({intervals:s,events:i,method:n.method,compliance:n.compliance,safetyFactor:n.safetyFactor,efficiency:n.efficiency}),p=function(e,t,a){let n=Math.max(0,...e.map(e=>e.excessKw));return o.map(a=>(function(e,t,a,n,s){let i=s?.powerCapKw??(a>0?a:Math.min(n,t/.5)),r=t*(s?.initialSocRatio??.5),l=0,c=0,p=0,h=0,u=0,m=e.map(e=>{if(e.excessKw>0){l+=1,p+=e.excessKwh;let t=Math.min(.25*Math.min(e.excessKw,i),r),a=t/.25;r-=t;let n=e.excessKw-a;return n>0&&(c+=1,h+=.25*n),u=Math.max(u,n),{timestamp:e.timestamp,originalKw:e.consumptionKw,shavedKw:e.consumptionKw-a}}return{timestamp:e.timestamp,originalKw:e.consumptionKw,shavedKw:e.consumptionKw}}),w=0===p?1:1-h/p;return{optionLabel:o.find(e=>e.capacityKwh===t)?.label??`${t} kWh`,capacityKwh:t,exceedanceIntervalsBefore:l,exceedanceIntervalsAfter:c,exceedanceEnergyKwhBefore:p,exceedanceEnergyKwhAfter:h,achievedCompliance:w,maxRemainingExcessKw:u,shavedSeries:m}})(e,a.capacityKwh,t,n,void 0))}(s,r.kWNeeded),h=function(e){if(0===e.length)return{rows:0,startDate:null,endDate:null,missingIntervalsCount:0,duplicateCount:0,non15MinIntervals:0,warnings:["No rows found in dataset."]};let t=e.map(e=>new Date(e.timestamp)).filter(e=>!Number.isNaN(e.getTime())).sort((e,t)=>e.getTime()-t.getTime()),a=t.length-new Set(t.map(e=>e.toISOString())).size,n=0,s=0;for(let e=1;e<t.length;e+=1){let a=(t[e].getTime()-t[e-1].getTime())/6e4;15!==a&&(n+=1,a>15&&(s+=Math.max(0,Math.round(a/15)-1)))}let i=[];return a>0&&i.push(`Detected ${a} duplicate timestamps.`),n>0&&i.push(`Detected ${n} non-15-minute interval transitions.`),{rows:e.length,startDate:t[0]?.toISOString()??null,endDate:t[t.length-1]?.toISOString()??null,missingIntervalsCount:s,duplicateCount:a,non15MinIntervals:n,warnings:i}}(n.rows);return l.NextResponse.json({intervals:s,events:i,sizing:r,scenarios:p,quality:h})}let h=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/analyze/route",pathname:"/api/analyze",filename:"route",bundlePath:"app/api/analyze/route"},resolvedPagePath:"C:\\Users\\Micha\\Kwartier-data advies peak shaving\\kwartier-advies\\app\\api\\analyze\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:u,staticGenerationAsyncStorage:m,serverHooks:w}=h,x="/api/analyze/route";function d(){return(0,r.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:m})}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[276,972],()=>a(6272));module.exports=n})();