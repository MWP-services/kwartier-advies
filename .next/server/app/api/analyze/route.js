"use strict";(()=>{var e={};e.id=652,e.ids=[652],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6272:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>d,patchFetch:()=>K,requestAsyncStorage:()=>h,routeModule:()=>p,serverHooks:()=>x,staticGenerationAsyncStorage:()=>w});var n={};a.r(n),a.d(n,{POST:()=>u});var i=a(9303),s=a(8716),r=a(670),o=a(7070),l=a(103);let m=[{label:"WattsNext ESS Cabinet 64 kWh",capacityKwh:64},{label:"WattsNext ESS Cabinet 96 kWh",capacityKwh:96},{label:"ESS All-in-one Cabinet 261 kWh",capacityKwh:261},{label:"WattsNext All-in-one Container 2.09 MWh",capacityKwh:2090},{label:"WattsNext All in-one Container 5.01 MWh",capacityKwh:5010}];function c(e,t){if(0===e.length)return 0;let a=[...e].sort((e,t)=>e-t),n=Math.ceil(t/100*a.length)-1;return a[Math.max(0,Math.min(n,a.length-1))]}async function u(e){var t,a;let n=await e.json(),i=(t=n.rows,a=n.contractedPowerKw,t.map(e=>{let t=(0,l.Z)(e.timestamp),n=Number.isNaN(t.getTime())?e.timestamp:t.toISOString(),i=e.consumptionKwh/.25,s=Math.max(0,i-a);return{...e,timestamp:n,consumptionKw:i,excessKw:s,excessKwh:.25*s}})),s=function(e){let t=[],a=null;return e.forEach((e,n)=>{e.excessKw>0?(a||(a={peakTimestamp:e.timestamp,durationIntervals:0,maxExcessKw:0,totalExcessKwh:0,intervalIndexes:[]}),a.durationIntervals+=1,(e.excessKw>a.maxExcessKw||e.excessKw===a.maxExcessKw&&e.timestamp<a.peakTimestamp)&&(a.maxExcessKw=e.excessKw,a.peakTimestamp=e.timestamp),a.totalExcessKwh+=e.excessKwh,a.intervalIndexes.push(n)):a&&(t.push(a),a=null)}),a&&t.push(a),t}(i),r=function(e){let{intervals:t,events:a,method:n,compliance:i,safetyFactor:s,efficiency:r}=e,o=0,l=0;if("MAX_PEAK"===n){let e=[...a].sort((e,t)=>t.totalExcessKwh-e.totalExcessKwh)[0];e&&(o=e.totalExcessKwh,l=e.maxExcessKw)}if("P95"===n){if(a.length<20){let e=[...a].sort((e,t)=>t.totalExcessKwh-e.totalExcessKwh)[0];e&&(o=e.totalExcessKwh,l=e.maxExcessKw)}else o=c(a.map(e=>e.totalExcessKwh),95),l=c(a.map(e=>e.maxExcessKw),95)}if("FULL_COVERAGE"===n){let e=new Map;t.forEach(t=>{let a=t.timestamp.slice(0,10),n=e.get(a)??[];n.push(t),e.set(a,n)});let a=0,n=0;e.forEach(e=>{let t=e.reduce((e,t)=>e+t.excessKwh,0);t>a&&(a=t,n=Math.max(...e.map(e=>e.excessKw)))}),o=a,l=n}let u=(o*=i)/r*s,p=(l*=i)*s,h=m.find(e=>u<=e.capacityKwh)??m[m.length-1],w=m.findIndex(e=>e.capacityKwh===h.capacityKwh);return{kWhNeededRaw:o,kWNeededRaw:l,kWhNeeded:u,kWNeeded:p,recommendedProduct:h,alternativeProduct:m[w+1]??null}}({intervals:i,events:s,method:n.method,compliance:n.compliance,safetyFactor:n.safetyFactor,efficiency:n.efficiency}),u=function(e,t,a){let n=Math.max(0,...e.map(e=>e.excessKw));return m.map(a=>(function(e,t,a,n,i){let s=i?.powerCapKw??(a>0?a:Math.min(n,t/.5)),r=i?.initialSocRatio??.5,o=Math.max(0,...e.map(e=>e.consumptionKw-e.excessKw)),l=t*r,c=0,u=0,p=0,h=0,w=0,x=new Map,d=e.map(e=>{let a=e.timestamp.slice(0,10),n=x.get(a)??{before:0,after:0};x.set(a,n);let i=Math.max(0,o-e.consumptionKw);if(l=Math.min(t,l+.25*Math.min(i,s)*.95),e.excessKw>0){c+=1,p+=e.excessKwh,n.before+=e.excessKwh;let t=Math.min(.25*Math.min(e.excessKw,s),l);l-=t;let a=e.excessKw-t/.25;return a>0&&(u+=1,h+=.25*a,n.after+=.25*a),w=Math.max(w,a),{timestamp:e.timestamp,originalKw:e.consumptionKw,shavedKw:e.consumptionKw-t/.25}}return{timestamp:e.timestamp,originalKw:e.consumptionKw,shavedKw:e.consumptionKw}}),K=0===p?1:1-h/p,f=Array.from(x.values()).map(({before:e,after:t})=>0===e?1:1-t/e),g=0===f.length?1:f.reduce((e,t)=>e+t,0)/f.length;return{optionLabel:m.find(e=>e.capacityKwh===t)?.label??`${t} kWh`,capacityKwh:t,exceedanceIntervalsBefore:c,exceedanceIntervalsAfter:u,exceedanceEnergyKwhBefore:p,exceedanceEnergyKwhAfter:h,achievedComplianceDataset:K,achievedComplianceDailyAverage:g,achievedCompliance:K,maxRemainingExcessKw:w,shavedSeries:d}})(e,a.capacityKwh,t,n,void 0))}(i,r.kWNeeded),p=function(e){if(0===e.length)return{rows:0,startDate:null,endDate:null,missingIntervalsCount:0,duplicateCount:0,non15MinIntervals:0,warnings:["No rows found in dataset."]};let t=e.map(e=>new Date(e.timestamp)).filter(e=>!Number.isNaN(e.getTime())).sort((e,t)=>e.getTime()-t.getTime()),a=t.length-new Set(t.map(e=>e.toISOString())).size,n=0,i=0;for(let e=1;e<t.length;e+=1){let a=(t[e].getTime()-t[e-1].getTime())/6e4;15!==a&&(n+=1,a>15&&(i+=Math.max(0,Math.round(a/15)-1)))}let s=[];return a>0&&s.push(`Detected ${a} duplicate timestamps.`),n>0&&s.push(`Detected ${n} non-15-minute interval transitions.`),{rows:e.length,startDate:t[0]?.toISOString()??null,endDate:t[t.length-1]?.toISOString()??null,missingIntervalsCount:i,duplicateCount:a,non15MinIntervals:n,warnings:s}}(n.rows);return o.NextResponse.json({intervals:i,events:s,sizing:r,scenarios:u,quality:p})}let p=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/analyze/route",pathname:"/api/analyze",filename:"route",bundlePath:"app/api/analyze/route"},resolvedPagePath:"C:\\Users\\Micha\\Kwartier-data advies peak shaving\\kwartier-advies\\app\\api\\analyze\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:h,staticGenerationAsyncStorage:w,serverHooks:x}=p,d="/api/analyze/route";function K(){return(0,r.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:w})}},103:(e,t,a)=>{a.d(t,{Z:()=>i,i:()=>s});let n=Date.UTC(1899,11,30);function i(e){if(e instanceof Date)return e;if("number"==typeof e&&Number.isFinite(e))return new Date(n+864e5*e);let t=String(e??"").trim();if(!t)return new Date(Number.NaN);let a=Number(t);return new Date(Number.isFinite(a)&&/^\d+(\.\d+)?$/.test(t)?n+864e5*a:t)}function s(e){let t="string"==typeof e?i(e):e;if(Number.isNaN(t.getTime()))return"-";let a=Object.fromEntries(new Intl.DateTimeFormat("nl-NL",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1,timeZone:"Europe/Amsterdam"}).formatToParts(t).map(e=>[e.type,e.value]));return`${a.day}-${a.month}-${a.year} ${a.hour}:${a.minute}`}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[276,972],()=>a(6272));module.exports=n})();